---
// src/pages/index.astro (Versión final con todas las correcciones de TypeScript)
import Layout from '../layouts/Layout.astro';
import HeroSection from '../components/HeroSection.astro';
import AboutSection from '../components/AboutSection.astro';
import ServicesSection from '../components/ServicesSection.astro';
import PlatformsSection from '../components/PlatformsSection.astro';
import ProjectsSection from '../components/ProjectsSection.astro';
import TestimonialsSection from '../components/TestimonialsSection.astro';
import StatsSection from '../components/StatsSection.astro';
import SuccessCasesModal from '../components/SuccessCasesModal.astro';
---
<Layout title="S&G Soluciones de Ingeniería | Automatización y Proyectos">
  <main>
    <HeroSection />
    <AboutSection />
    <ServicesSection />
    <PlatformsSection />
    <ProjectsSection />
    <TestimonialsSection />
    <StatsSection />
  </main>
  <SuccessCasesModal />
</Layout>

<script>
  // FIX: Le decimos a TypeScript el tipo exacto de cada elemento
  const modal = document.getElementById('success-modal') as HTMLElement;
  const closeBtn = document.getElementById('close-modal-btn') as HTMLElement;
  const openCards = document.querySelectorAll('.open-modal-card') as NodeListOf<HTMLElement>;

  if (modal && closeBtn && openCards.length > 0) {
    const openModal = (slideIndex = 0) => {
      // Usamos style.display para mostrar/ocultar. Es más directo que cambiar clases.
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      document.dispatchEvent(new CustomEvent('modal-opened', { 
        detail: { slideIndex: slideIndex } 
      }));
    };

    const closeModal = () => {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    };

    openCards.forEach(card => {
      card.addEventListener('click', () => {
        // FIX: El '!' le asegura a TypeScript que 'slideIndex' no será nulo
        const slideIndex = parseInt(card.dataset.slideIndex!, 10);
        openModal(slideIndex);
      });
    });

    closeBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (event) => {
      if (event.target === modal) closeModal();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && modal.style.display !== 'none') {
        closeModal();
      }
    });
  }
</script>