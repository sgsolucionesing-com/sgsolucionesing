---
// ProjectsSection.astro - Carrusel de tarjetas de proyectos
import { Icon } from 'astro-icon/components';
import { slides } from '../data/casos-exito.js';

// Helper function para obtener la URL de la imagen
function getImageSrc(imageSrc: any): string {
  if (typeof imageSrc === 'string') {
    return imageSrc;
  }
  if (imageSrc && typeof imageSrc === 'object' && imageSrc.src) {
    return imageSrc.src;
  }
  return '';
}

// Filtrar proyectos para el carrusel
// Excluir slides de contacto y portada principal, tomar los primeros 6 proyectos
const featuredProjects = slides.filter(slide =>
  !slide.isContact &&
  !slide.subtitle &&
  slide.images &&
  slide.images.length > 0
).slice(0, 6);
---

<section id="proyectos" class="py-20 lg:py-24 bg-gray-50 section-with-pattern overflow-hidden">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16 fade-in-element">
      <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">Proyectos Destacados</h2>
      <p class="text-lg lg:text-xl text-gray-600 max-w-3xl mx-auto">Explora una selección de nuestros casos de éxito más recientes.</p>
    </div>
  </div>
  
  <!-- Carrusel de proyectos -->
  <div class="relative px-4 sm:px-6 lg:px-8 fade-in-element">
    <div class="splide project-carousel" id="project-carousel">
      <div class="splide__track">
        <ul class="splide__list">
          {featuredProjects.map((project, index) => (
            <li class="splide__slide">
              <div class="mx-2 md:mx-3">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden project-card group flex flex-col h-full cursor-pointer open-modal-card hover:shadow-2xl transition-all duration-300" data-slide-index={index + 1}>
                  <!-- Imagen del proyecto -->
                  <div class="relative h-48 md:h-56 overflow-hidden">
                    <img 
                      src={getImageSrc(project.images[0].src)} 
                      alt={project.title} 
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                    <div class="absolute top-4 right-4">
                      <div class="bg-primary/90 text-white text-xs font-semibold px-2 py-1 rounded-full backdrop-blur-sm">
                        Proyecto #{index + 1}
                      </div>
                    </div>
                  </div>
                  
                  <!-- Contenido de la tarjeta -->
                  <div class="p-5 flex flex-col flex-grow">
                    <div class="mb-3">
                      <span class="inline-block bg-primary/10 text-primary text-sm font-medium px-3 py-1 rounded-full mb-3">
                        {project.title}
                      </span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-3 line-clamp-2">
                      {project.description.length > 90 ? project.description.substring(0, 90) + '...' : project.description}
                    </h3>
                    <div class="mt-auto">
                      <button class="w-full bg-gradient-to-r from-primary to-secondary text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                        <span>Ver Galería</span>
                        <Icon name="mdi:arrow-right" class="h-4 w-4 ml-2 group-hover:translate-x-1 transition-transform duration-300" />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </div>
  <div class="text-center mt-20 fade-in-element">
    <a href="/casos-exito" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-secondary transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
      Ver Todos los Proyectos
    </a>
  </div>
</section>

<!-- Cargar Splide desde CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
<script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

<script is:inline>
  function initProjectCarousel() {
    // Esperar a que Splide esté disponible
    if (typeof Splide === 'undefined') {
      setTimeout(initProjectCarousel, 100);
      return;
    }
    
    const carouselElement = document.querySelector('#project-carousel');
    if (!carouselElement) return;
    
    // Verificar si ya está inicializado
    if (carouselElement.classList.contains('is-initialized')) return;
    
    try {
      const carousel = new Splide(carouselElement, {
        type: 'loop',
        perPage: 3, // Mostrar 3 cards en desktop
        perMove: 1,
        gap: '1rem',
        pagination: true,
        arrows: true,
        autoplay: true,
        interval: 3500,
        pauseOnHover: true,
        resetProgress: false,
        breakpoints: {
          1024: { // Tablet
            perPage: 2,
            gap: '0.75rem'
          },
          768: { // Mobile
            perPage: 1,
            gap: '0.5rem'
          }
        },
        // Configuración adicional para suavidad
        speed: 800,
        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
      });
      
      carousel.mount();
      carouselElement.classList.add('is-initialized');
      
      // Agregar funcionalidad de pausa en hover para las cards
      const cards = carouselElement.querySelectorAll('.project-card');
      cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
          if (carousel.Components.Autoplay) {
            carousel.Components.Autoplay.pause();
          }
        });
        
        card.addEventListener('mouseleave', () => {
          if (carousel.Components.Autoplay) {
            carousel.Components.Autoplay.play();
          }
        });
      });
      
    } catch (error) {
      console.error('Error inicializando carrusel de proyectos:', error);
    }
  }
  
  // Inicializar cuando todo esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initProjectCarousel, 500);
    });
  } else {
    setTimeout(initProjectCarousel, 500);
  }
</script>

<style is:global>
 /* Estilos del carrusel de proyectos */
 #project-carousel {
   padding-bottom: 4rem;
 }
 
 /* Estilos para las flechas del carrusel */
 #project-carousel .splide__arrow { 
   background-color: white; 
   box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
   border-radius: 50%;
   width: 3.5rem;
   height: 3.5rem;
   opacity: 0.9;
   transition: all 0.3s ease;
   z-index: 2;
 }
 
 #project-carousel .splide__arrow:hover {
   opacity: 1;
   transform: scale(1.1);
   box-shadow: 0 6px 25px rgba(0,0,0,0.2);
 }
 
 #project-carousel .splide__arrow svg { 
   fill: var(--primary-color); 
   width: 1.75rem;
   height: 1.75rem;
 }
 
 #project-carousel .splide__arrow--prev {
   left: -1rem;
 }
 
 #project-carousel .splide__arrow--next {
   right: -1rem;
 }
 
 /* Estilos para la paginación */
 #project-carousel .splide__pagination {
   bottom: -2.5rem;
   justify-content: center;
   gap: 0.5rem;
 }
 
 #project-carousel .splide__pagination__page {
   background-color: #d1d5db;
   opacity: 0.6;
   transition: all 0.3s ease;
   width: 12px;
   height: 12px;
   border-radius: 50%;
 }
 
 #project-carousel .splide__pagination__page.is-active {
   background-color: var(--primary-color);
   opacity: 1;
   transform: scale(1.3);
 }
 
 /* Patrón de fondo */
 .section-with-pattern {
   background-image: radial-gradient(circle at 1px 1px, #e5e7eb 1px, transparent 0); 
   background-size: 20px 20px;
 }
 
 /* Estilos de las tarjetas de proyecto */
 .project-card { 
   transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
   height: 100%;
   min-height: 320px;
 }
 
 .project-card:hover { 
   transform: translateY(-8px) scale(1.02);
   box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
 }
 
 .project-card button:hover {
   transform: translateY(-1px);
 }
 
 /* Utilidad para limitar líneas de texto */
 .line-clamp-2 {
   display: -webkit-box;
   -webkit-line-clamp: 2;
   -webkit-box-orient: vertical;
   overflow: hidden;
   line-height: 1.5;
   height: 3rem;
 }
 
 /* Animaciones de fade-in */
 .fade-in-element { 
   opacity: 0; 
   transform: translateY(30px); 
   transition: opacity 0.6s ease-out, transform 0.6s ease-out; 
 }
 
 .fade-in-element.is-visible { 
   opacity: 1; 
   transform: translateY(0); 
 }
 
 /* Responsive: ocultar flechas en mobile */
 @media (max-width: 768px) {
   #project-carousel .splide__arrow {
     display: none;
   }
 }
 
 /* Mejora visual del track del carrusel */
 #project-carousel .splide__track {
   overflow: visible;
 }
 
 #project-carousel .splide__list {
   align-items: stretch;
 }
 
 #project-carousel .splide__slide {
   display: flex;
   align-items: stretch;
 }
</style>