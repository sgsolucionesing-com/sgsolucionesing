---
// ProjectsSection.astro - Carrusel de tarjetas de proyectos dinámicas
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';

// Obtener proyectos de la colección de contenido
const allProjects = await getCollection('proyectos');

// Ordenar por order y destacados primero, luego tomar los primeros 6
const featuredProjects = allProjects
  .sort((a, b) => {
    // Priorizar destacados
    if (a.data.destacado && !b.data.destacado) return -1;
    if (!a.data.destacado && b.data.destacado) return 1;
    // Luego por order
    return (a.data.order ?? 999) - (b.data.order ?? 999);
  })
  .slice(0, 6);

// Helper function para generar URL del proyecto
const toProjectUrl = (project: any) => `/proyectos/${project.slug ?? project.id.split('/').pop()?.replace(/\.mdx?$/, '')}`;
---

<section id="proyectos" class="py-20 lg:py-24 bg-gray-50 section-with-pattern overflow-hidden">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16 fade-in-element">
      <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">Proyectos Destacados</h2>
      <p class="text-lg lg:text-xl text-gray-600 max-w-3xl mx-auto">Explora una selección de nuestros casos de éxito más recientes.</p>
    </div>
  </div>
  
  <!-- Carrusel de proyectos -->
  <div class="relative px-4 sm:px-6 lg:px-8 fade-in-element">
    <div class="splide project-carousel" id="project-carousel">
      <div class="splide__track">
        <ul class="splide__list">
          {featuredProjects.map((project, index) => (
            <li class="splide__slide">
              <div class="mx-2 md:mx-3">
                <a 
                  href={toProjectUrl(project)} 
                  class="bg-white rounded-xl shadow-lg overflow-hidden project-card group flex flex-col h-full cursor-pointer hover:shadow-2xl transition-all duration-300 block"
                >
                  <!-- Imagen del proyecto -->
                  <div class="relative h-48 md:h-56 overflow-hidden">
                    <img 
                      src={project.data.coverImage} 
                      alt={project.data.title} 
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                    <div class="absolute top-4 left-4">
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-primary/90 text-white backdrop-blur-sm">
                        <Icon name="mdi:factory" class="w-3 h-3 mr-1" />
                        {project.data.sector}
                      </span>
                    </div>
                    {project.data.destacado && (
                      <div class="absolute top-4 right-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-amber-500 text-white backdrop-blur-sm">
                          <Icon name="mdi:star" class="w-3 h-3 mr-1" />
                          Destacado
                        </span>
                      </div>
                    )}
                  </div>
                  
                  <!-- Contenido de la tarjeta -->
                  <div class="p-5 flex flex-col flex-grow">
                    <div class="mb-3">
                      <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 group-hover:text-primary transition-colors">
                        {project.data.title}
                      </h3>
                      <p class="text-sm text-gray-600 line-clamp-3 leading-relaxed">
                        {project.data.resumen}
                      </p>
                    </div>
                    
                    {/* KPIs si están disponibles */}
                    {project.data.kpis && project.data.kpis.length > 0 && (
                      <div class="flex gap-3 mb-3 text-xs">
                        {project.data.kpis.slice(0, 2).map((kpi: any) => (
                          <span class="text-gray-500">
                            <strong class="text-primary">{kpi.value}</strong> {kpi.label}
                          </span>
                        ))}
                      </div>
                    )}
                    
                    <div class="mt-auto">
                      <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                        {project.data.cliente && (
                          <span class="flex items-center">
                            <Icon name="mdi:domain" class="w-3 h-3 mr-1" />
                            {project.data.cliente}
                          </span>
                        )}
                        {project.data.fecha && (
                          <span class="flex items-center">
                            <Icon name="mdi:calendar" class="w-3 h-3 mr-1" />
                            {project.data.fecha}
                          </span>
                        )}
                      </div>
                      <div class="w-full bg-gradient-to-r from-primary to-secondary text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center group-hover:shadow-lg transition-all duration-300">
                        <span>Ver Proyecto</span>
                        <Icon name="mdi:arrow-right" class="h-4 w-4 ml-2 group-hover:translate-x-1 transition-transform duration-300" />
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </div>
  <div class="text-center mt-20 fade-in-element">
    <a href="/proyectos" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-secondary transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
      Ver Todos los Proyectos
    </a>
  </div>
</section>

<!-- Cargar Splide desde CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
<script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

<script is:inline>
  function initProjectCarousel() {
    // Esperar a que Splide esté disponible
    if (typeof Splide === 'undefined') {
      setTimeout(initProjectCarousel, 100);
      return;
    }
    
    const carouselElement = document.querySelector('#project-carousel');
    if (!carouselElement) return;
    
    // Verificar si ya está inicializado
    if (carouselElement.classList.contains('is-initialized')) return;
    
    try {
      const carousel = new Splide(carouselElement, {
        type: 'loop',
        perPage: 3, // Mostrar 3 cards en desktop
        perMove: 1,
        gap: '1rem',
        pagination: true,
        arrows: true,
        autoplay: true,
        interval: 3500,
        pauseOnHover: true,
        resetProgress: false,
        breakpoints: {
          1024: { // Tablet
            perPage: 2,
            gap: '0.75rem'
          },
          768: { // Mobile
            perPage: 1,
            gap: '0.5rem'
          }
        },
        // Configuración adicional para suavidad
        speed: 800,
        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
      });
      
      carousel.mount();
      carouselElement.classList.add('is-initialized');
      
      // Agregar funcionalidad de pausa en hover para las cards
      const cards = carouselElement.querySelectorAll('.project-card');
      cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
          if (carousel.Components.Autoplay) {
            carousel.Components.Autoplay.pause();
          }
        });
        
        card.addEventListener('mouseleave', () => {
          if (carousel.Components.Autoplay) {
            carousel.Components.Autoplay.play();
          }
        });
      });
      
    } catch (error) {
      console.error('Error inicializando carrusel de proyectos:', error);
    }
  }
  
  // Inicializar cuando todo esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initProjectCarousel, 500);
    });
  } else {
    setTimeout(initProjectCarousel, 500);
  }
</script>

<style is:global>
 /* Estilos del carrusel de proyectos */
 #project-carousel {
   padding-bottom: 4rem;
 }
 
 /* Estilos para las flechas del carrusel */
 #project-carousel .splide__arrow { 
   background-color: white; 
   box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
   border-radius: 50%;
   width: 3.5rem;
   height: 3.5rem;
   opacity: 0.9;
   transition: all 0.3s ease;
   z-index: 2;
 }
 
 #project-carousel .splide__arrow:hover {
   opacity: 1;
   transform: scale(1.1);
   box-shadow: 0 6px 25px rgba(0,0,0,0.2);
 }
 
 #project-carousel .splide__arrow svg { 
   fill: var(--primary-color); 
   width: 1.75rem;
   height: 1.75rem;
 }
 
 #project-carousel .splide__arrow--prev {
   left: -1rem;
 }
 
 #project-carousel .splide__arrow--next {
   right: -1rem;
 }
 
 /* Estilos para la paginación */
 #project-carousel .splide__pagination {
   bottom: -2.5rem;
   justify-content: center;
   gap: 0.5rem;
 }
 
 #project-carousel .splide__pagination__page {
   background-color: #d1d5db;
   opacity: 0.6;
   transition: all 0.3s ease;
   width: 12px;
   height: 12px;
   border-radius: 50%;
 }
 
 #project-carousel .splide__pagination__page.is-active {
   background-color: var(--primary-color);
   opacity: 1;
   transform: scale(1.3);
 }
 
 /* Patrón de fondo */
 .section-with-pattern {
   background-image: radial-gradient(circle at 1px 1px, #e5e7eb 1px, transparent 0); 
   background-size: 20px 20px;
 }
 
 /* Estilos de las tarjetas de proyecto */
 .project-card { 
   transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
   height: 100%;
   min-height: 320px;
 }
 
 .project-card:hover { 
   transform: translateY(-8px) scale(1.02);
   box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
 }
 
 .project-card button:hover {
   transform: translateY(-1px);
 }
 
 /* Utilidad para limitar líneas de texto */
 .line-clamp-2 {
   display: -webkit-box;
   -webkit-line-clamp: 2;
   -webkit-box-orient: vertical;
   overflow: hidden;
   line-height: 1.5;
   height: 3rem;
 }
 
 .line-clamp-3 {
   display: -webkit-box;
   -webkit-line-clamp: 3;
   -webkit-box-orient: vertical;
   overflow: hidden;
   line-height: 1.4;
   height: 4.2rem;
 }
 
 /* Animaciones de fade-in */
 .fade-in-element { 
   opacity: 0; 
   transform: translateY(30px); 
   transition: opacity 0.6s ease-out, transform 0.6s ease-out; 
 }
 
 .fade-in-element.is-visible { 
   opacity: 1; 
   transform: translateY(0); 
 }
 
 /* Responsive: ocultar flechas en mobile */
 @media (max-width: 768px) {
   #project-carousel .splide__arrow {
     display: none;
   }
 }
 
 /* Mejora visual del track del carrusel */
 #project-carousel .splide__track {
   overflow: visible;
 }
 
 #project-carousel .splide__list {
   align-items: stretch;
 }
 
 #project-carousel .splide__slide {
   display: flex;
   align-items: stretch;
 }
</style>