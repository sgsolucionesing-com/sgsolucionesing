---
// ProjectsSection.astro (Con filtro de datos mejorado)
import { Icon } from 'astro-icon/components';
import { slides } from '../data/casos-exito.js';

// CAMBIO CLAVE: Usamos un filtro más robusto e inteligente.
// 1. Quitamos la slide de "Contacto" (isContact).
// 2. Quitamos la slide de "Portada Principal" (la que tiene subtitle).
// 3. Tomamos los primeros 3 resultados de lo que queda.
const featuredProjects = slides.filter(slide =>
  !slide.isContact &&
  !slide.subtitle &&
  slide.images &&
  slide.images.length > 0
).slice(0, 3);
---

<section id="proyectos" class="py-20 lg:py-24 bg-gray-50 section-with-pattern overflow-hidden">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16 fade-in-element">
      <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">Proyectos Destacados</h2>
      <p class="text-lg lg:text-xl text-gray-600 max-w-3xl mx-auto">Explora una selección de nuestros casos de éxito más recientes.</p>
    </div>
  </div>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 fade-in-element">
    <section class="splide project-splide">
      <div class="splide__track">
        <ul class="splide__list">
          {featuredProjects.map((project, index) => (
            <li class="splide__slide">
              <div class="bg-white rounded-xl shadow-lg overflow-hidden project-card group flex flex-col h-full cursor-pointer open-modal-card" data-slide-index={index}>
                <div class="relative h-64 overflow-hidden">
                  <img src={project.images[0].src} alt={project.title} class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                  <div class="absolute bottom-0 left-0 p-4">
                    <span class="bg-primary text-white text-sm font-medium px-3 py-1 rounded-full">{project.title}</span>
                  </div>
                </div>
                <div class="p-6 flex flex-col flex-grow">
                  <h3 class="text-xl font-bold text-gray-900 mb-2">{project.description.substring(0, 80)}...</h3>
                  <p class="mt-auto text-primary font-medium flex items-center">
                    Ver galería interactiva <Icon name="mdi:arrow-right" class="h-5 w-5 ml-1" />
                  </p>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </div>
    </section>
  </div>
  <div class="text-center mt-12 fade-in-element">
    <a href="/casos-exito" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-secondary transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
      Ver Todos los Proyectos
    </a>
  </div>
</section>

<script>
  import Splide from '@splidejs/splide';
  import type { Splide as SplideInstance } from '@splidejs/splide';
  import '@splidejs/splide/css/core';

  interface SplideElement extends HTMLElement {
    splide?: SplideInstance;
  }

  function initProjectSplide() {
    const splideElement = document.querySelector<SplideElement>('.project-splide');
    if (!splideElement || splideElement.splide) return;
    new Splide(splideElement, {
      type: 'loop',
      perPage: 3,
      perMove: 1,
      gap: '2rem',
      pagination: false,
      breakpoints: {
        1024: { perPage: 2 },
        768: { perPage: 1 },
      }
    }).mount();
  }
  document.addEventListener('astro:page-load', initProjectSplide);
  document.addEventListener('astro:before-swap', () => {
    const splideElement = document.querySelector<SplideElement>('.project-splide');
    if (splideElement && splideElement.splide) {
      splideElement.splide.destroy();
    }
  });
</script>

<style is:global>
 .splide__arrow { background-color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
 .splide__arrow svg { fill: var(--primary-color); }
 .section-with-pattern {background-image: radial-gradient(circle at 1px 1px, #e5e7eb 1px, transparent 0); background-size: 20px 20px;}
 .project-card { transition: all 0.3s ease; }
 .project-card:hover { transform: translateY(-10px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2); }
 .fade-in-element { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
 .fade-in-element.is-visible { opacity: 1; transform: translateY(0); }
</style>